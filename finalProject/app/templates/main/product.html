{% extends "main/baseTemplate.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">{{ product.name }}</h3>
                </div>
                <div class="card-body">
                    {% if product.image_url %}
                        <img src="{{ url_for('static', filename='images/' ~ product.image_url) }}" class="img-fluid mb-3" alt="{{ product.name }}" id="productImage">
                    {% else %}
                        <img src="{{ url_for('static', filename='images/default_image.jpg') }}" class="img-fluid mb-3" alt="{{ product.name }}" id="productImage">
                    {% endif %}
                    <p>{{ product.description }}</p>
                    <p>–¶–µ–Ω–∞: {{ product.price }} —Ä—É–±.</p>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        {% if in_cart %}
                            <button class="btn btn-danger toggle-cart" data-product-id="{{ product.id }}" data-action="remove">–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã</button>
                        {% else %}
                            <button class="btn btn-success toggle-cart" data-product-id="{{ product.id }}" data-action="add">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
                        {% endif %}
                        {% if in_saved %}
                            <button class="btn btn-outline-success btn-sm save-product" data-product-id="{{ product.id }}" data-action="remove">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</button>
                        {% else %}
                            <button class="btn btn-outline-secondary btn-sm save-product" data-product-id="{{ product.id }}" data-action="add">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        {% endif %}
                    </div>
                    <hr>
                    <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
                    <h5>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h5>
                    <div id="reviews{{ product.id }}">
                        {% for review in reviews %}
                            <div class="review">
                                <p><strong>{{ review.user.username }}</strong> {{ review.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                <p>{{ review.content }}</p>
                                <button class="btn btn-outline-success like-review" data-review-id="{{ review.id }}">üëç {{ review.likes_count }}</button>
                                <button class="btn btn-outline-danger dislike-review" data-review-id="{{ review.id }}">üëé {{ review.dislikes_count }}</button>
                                {% if current_user.is_authenticated and (current_user.id == review.user_id or current_user.can(Permission.MODERATE)) %}
                                    <button class="btn btn-outline-danger delete-review" data-review-id="{{ review.id }}">–£–¥–∞–ª–∏—Ç—å</button>
                                {% endif %}
                            </div>
                            <hr>
                        {% endfor %}
                    </div>
                    {% if current_user.is_authenticated %}
                        {% if not reviews|selectattr("user_id", "equalto", current_user.id)|list %}
                            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                            <form action="{{ url_for('main.add_review', product_id=product.id) }}" method="post">
                                {{ form.hidden_tag() }}
                                <div class="form-group">
                                    <textarea class="form-control" name="content" rows="3" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary mt-2">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                            </form>
                        {% else %}
                            <p>–í—ã —É–∂–µ –æ—Å—Ç–∞–≤–∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä.</p>
                        {% endif %}
                    {% else %}
                        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="{{ url_for('auth.login') }}">–≤–æ–π–¥–∏—Ç–µ</a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">{{ product.name }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                {% if product.image_url %}
                    <img src="{{ url_for('static', filename='images/' ~ product.image_url) }}" class="img-fluid enlarged-image" alt="{{ product.name }}">
                {% else %}
                    <img src="{{ url_for('static', filename='images/default_image.jpg') }}" class="img-fluid enlarged-image" alt="{{ product.name }}">
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    /**
     * –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º.
     */
    document.getElementById('productImage').addEventListener('click', function() {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤/–∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∏–ª–∏ "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     * –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç
     * –∏ —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏.
     */
    document.querySelector('.save-product').addEventListener('click', function() {
        const productId = this.dataset.productId;
        const action = this.dataset.action;
        fetch('/toggle_save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ form.csrf_token._value() }}'
            },
            body: JSON.stringify({
                product_id: productId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (action === 'add') {
                    this.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-outline-success');
                    this.dataset.action = 'remove';
                } else {
                    this.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    this.classList.remove('btn-outline-success');
                    this.classList.add('btn-outline-secondary');
                    this.dataset.action = 'add';
                }
            } else {
                alert(data.message);
            }
        });
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤/–∏–∑ –∫–æ—Ä–∑–∏–Ω—É
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É" –∏–ª–∏ "–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã" –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è
     * –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã. –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç
     * –∏ —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏.
     */
    document.querySelectorAll('.toggle-cart').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.dataset.productId;
            const action = this.dataset.action;
            fetch('/toggle_cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ form.csrf_token._value() }}'
                },
                body: JSON.stringify({
                    product_id: productId,
                    action: action
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (action === 'add') {
                        this.textContent = '–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã';
                        this.classList.remove('btn-success');
                        this.classList.add('btn-danger');
                        this.dataset.action = 'remove';
                    } else {
                        this.textContent = '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-success');
                        this.dataset.action = 'add';
                    }
                } else {
                    alert(data.message);
                }
            });
        });
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –ª–∞–π–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–∞–π–∫–∞.
     * –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤ —É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
     */
    document.querySelectorAll('.like-review').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            fetch(`/review/${reviewId}/like`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ form.csrf_token._value() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.textContent = `üëç ${data.likes_count}`;
                    const dislikeButton = document.querySelector(`.dislike-review[data-review-id="${reviewId}"]`);
                    if (dislikeButton) {
                        dislikeButton.textContent = `üëé ${data.dislikes_count}`;
                    }
                } else {
                    alert(data.message);
                }
            });
        });
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∑–ª–∞–π–∫–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–∏–∑–ª–∞–π–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∏–∑–ª–∞–π–∫–∞.
     * –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–∏–∑–ª–∞–π–∫–æ–≤ –∏ –ª–∞–π–∫–æ–≤ —É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
     */
    document.querySelectorAll('.dislike-review').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            fetch(`/review/${reviewId}/dislike`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ form.csrf_token._value() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.textContent = `üëé ${data.dislikes_count}`;
                    const likeButton = document.querySelector(`.like-review[data-review-id="${reviewId}"]`);
                    if (likeButton) {
                        likeButton.textContent = `üëç ${data.likes_count}`;
                    }
                } else {
                    alert(data.message);
                }
            });
        });
    });

    /**
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
     *
     * –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
     * –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
     */
    document.querySelectorAll('.delete-review').forEach(button => {
        button.addEventListener('click', function() {
            const reviewId = this.dataset.reviewId;
            fetch(`/review/${reviewId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ form.csrf_token._value() }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message);
                }
            });
        });
    });
});
</script>

<style>
.enlarged-image {
    width: 100%;
    height: auto;
}
</style>

{% endblock %}
